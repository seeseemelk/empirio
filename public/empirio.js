(()=>{"use strict";var t,e,n,o=function(){this.type="play"},r=function(){function t(t){this._handler=t}return t.prototype.connect=function(){var t=this;this._socket=new WebSocket("ws://"+location.host+"/socket"),this._socket.onopen=function(){return t.onOpen()},this._socket.onerror=function(e){return t.onError(e)},this._socket.onmessage=function(e){return t.onMessage(e)}},t.prototype.send=function(t){var e=JSON.stringify(t);this._socket.send(e)},t.prototype.onOpen=function(){console.log("Socket Connected"),this._handler.onOpen()},t.prototype.onError=function(t){console.log("Socket error"),this._handler.onSocketError(t.toString())},t.prototype.onMessage=function(t){var e=JSON.parse(t.data);if(e&&e.type)switch(e.type){case"error":this._handler.onError(e);break;case"start":this._handler.onStart(e);break;case"playerJoin":this._handler.onPlayerJoined(e);break;case"tileChange":this._handler.onTileChangePacket(e);break;case"mapLoaded":this._handler.onMapLoadedPacket(e)}else this._handler.onSocketError("Bad packet received")},t}(),i=function(t,e,n){this.id=t,this.name=e,this.colour=n};!function(t){var e,n,o,r,i,s,a=function(){function t(){this.down=!1,this.dragging=!1}return t.prototype.zero=function(){this.startX=this.x,this.startY=this.y},t.prototype.dx=function(){return this.x-this.startX},t.prototype.dy=function(){return this.y-this.startY},t.prototype.distance=function(){var t=this.dx(),e=this.dy();return Math.sqrt(t*t+e*e)},t}();t.MouseDragEvent=a,function(t){t[t.lobby=0]="lobby",t[t.game=1]="game"}(e=t.Screen||(t.Screen={}));var c,l=new a;function u(t){n=t,o.style.display=t===e.lobby?"auto":"none",r.style.display=t===e.game?"block":"none"}t.init=function(t){c=t,o=document.getElementById("menu"),r=document.getElementById("game"),i=document.getElementById("spinner"),s=document.getElementById("spinnerImage"),u(e.lobby);var a=0;window.setInterval((function(){s.style.rotate=a+"deg",a+=45}),100),window.onselectstart=function(t){return n!=e.game||(l.down=!0,t.stopPropagation(),!1)},window.onmousedown=function(t){return n!=e.game||(l.down=!0,l.startX=t.clientX,l.startY=t.clientY,!1)},window.onmouseup=function(t){return n!=e.game||(l.down=!1,l.dragging=!1,t.stopPropagation(),!1)},window.onmousemove=function(t){return n!=e.game||(l.down&&(l.x=t.clientX,l.y=t.clientY,(l.dragging||l.distance()>=8)&&(l.dragging=!0,c.onDrag(l),l.zero(),t.stopPropagation())),!1)}},t.screen=function(){return n},t.show=u,t.showSpinner=function(){i.style.display="flex"},t.hideSpinner=function(){i.style.display="none"}}(t||(t={})),function(t){var e,n,o,r,i,s=function(){};t.State=s,t.init=function(t){i=t,e=document.getElementById("play-button"),n=document.getElementById("playername"),o=document.getElementById("colour"),r=document.getElementById("room"),e.addEventListener("click",(function(){var t=function(){var t=new s;return t.username=n.value,t.colour=o.value,""!==r.value&&(t.room=parseInt(r.value)),t}();i.onPlayClicked(t)}))},t.enablePlay=function(){e.disabled=!1},t.disablePlay=function(){e.disabled=!0}}(e||(e={})),function(t){var e,n,o;function r(){for(;e.firstChild;)e.removeChild(e.firstChild)}t.init=function(){e=document.getElementById("table-container"),n=document.getElementById("power"),o=document.getElementById("roomId")},t.clearContent=r,t.setContent=function(t){r(),e.appendChild(t)},t.setPower=function(t){n.innerText=t.toString()},t.setRoom=function(t){o.innerText="Room #"+t.toString()}}(n||(n={}));var s=function(){function t(t){this._strength=0,this._element=t}return t.prototype.setColour=function(t){console.log("Colour of "+this._element.id+": "+t),this._element.style.backgroundColor="#"+t},t.prototype.setOwner=function(t){this.setColour(t.colour)},t.prototype.setStrength=function(t){this._strength=t,this._element.innerText=0==t?"":t.toString()},t.prototype.strength=function(){return this._strength},t.prototype.element=function(){return this._element},t}(),a=function(){function t(t,e){this._x=0,this._y=0,this._width=t,this._height=e,this._tiles=this.createTiles(),this._table=this.createTable()}return t.prototype.width=function(){return this._width},t.prototype.height=function(){return this._height},t.prototype.show=function(){n.setContent(this._table)},t.prototype.update=function(){this._table.style.left=this._x+"px",this._table.style.top=this._y+"px"},t.prototype.get=function(t,e){return this._tiles[e][t]},t.prototype.onDrag=function(t){this._x+=t.dx(),this._y+=t.dy(),this.update()},t.prototype.createTiles=function(){for(var t=[],e=0;e<this._height;e++){for(var n=[],o=0;o<this._width;o++){var r=document.createElement("td");r.id="tile-"+o+"-"+e,n[o]=new s(r)}t[e]=n}return t},t.prototype.createTable=function(){var t=this,e=document.createElement("table");e.style.position="absolute";for(var n=function(n){for(var r=document.createElement("tr"),i=function(e){var i=o.get(n,e).element();i.innerText="",i.onclick=function(){return t.clickedTile(n,e)},r.appendChild(i)},s=0;s<o._height;s++)i(s);e.appendChild(r)},o=this,r=0;r<this._width;r++)n(r);return e},t.prototype.clickedTile=function(t,e){},t}(),c=function(){function t(t,e){this._players=new Map,this._field=new a(t.width,t.height),this._player=e,this.addPlayer(this._player),this._field.show()}return t.prototype.onDrag=function(t){this._field.onDrag(t)},t.prototype.onPlayerJoined=function(t){var e=new i(t.id,t.name,t.colour);this.addPlayer(e)},t.prototype.onTileChange=function(t){var e=this.getPlayer(t.owner);if(e){var n=this._field.get(t.x,t.y);console.log("Tile at "+t.x+","+t.y+" changed"),n.setOwner(e),n.setStrength(t.strength)}else console.log("Got bad player id")},t.prototype.addPlayer=function(t){this._players.set(t.id,t)},t.prototype.getPlayer=function(t){return this._players.get(t)},t}(),l=function(){function s(){this._connection=new r(this)}return s.prototype.start=function(){console.log("Starting..."),t.init(this),e.init(this),n.init(),e.disablePlay(),t.show(t.Screen.lobby),this._connection.connect(),t.hideSpinner(),console.log("Started!")},s.prototype.onSocketError=function(t){console.log("Socket error: "+t)},s.prototype.onOpen=function(){e.enablePlay()},s.prototype.onPlayClicked=function(e){t.showSpinner();var n=new o;n.colour=e.colour,n.username=e.username,n.room=e.room,this._playerColour=e.colour,this._playerName=e.username,this._connection.send(n)},s.prototype.onDrag=function(t){this._room&&this._room.onDrag(t)},s.prototype.onError=function(t){console.log("Got error: "+t.message)},s.prototype.onStart=function(e){n.setRoom(e.room);var o=new i(e.playerId,this._playerName,this._playerColour);this._room=new c(e,o),t.show(t.Screen.game)},s.prototype.onPlayerJoined=function(t){this._room&&this._room.onPlayerJoined(t)},s.prototype.onTileChangePacket=function(t){this._room&&this._room.onTileChange(t)},s.prototype.onMapLoadedPacket=function(e){t.hideSpinner()},s}();window.onload=function(){(new l).start()}})();